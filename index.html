<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Kalarava QR Scanner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDQ7zrV4Ao9TdJwD0BBOm1Cn7oSL1gEM1A",
  authDomain: "kalarava-scanner-52043.firebaseapp.com",
  databaseURL: "https://kalarava-scanner-52043-default-rtdb.firebaseio.com",
  projectId: "kalarava-scanner-52043",
  storageBucket: "kalarava-scanner-52043.firebasestorage.app",
  messagingSenderId: "550630251161",
  appId: "1:550630251161:web:33391388bb3398167a3608"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.checkEntry = async function (usn, checkOnly=false){
  usn = usn.trim().toUpperCase();
  const r = ref(db,"attendance/"+usn);
  const snap = await get(r);

  if(checkOnly){
    if(snap.exists()) return "DUPLICATE";
    return "VALID";
  }

  // If record exists, check status
if(snap.exists()){
  const data = snap.val();

  // If already exited, no re-entry allowed
  if(data.status === "exit"){
    return "BLOCKED"; // prevent re-entry
  }

  // If entry exists, this action becomes exit
  await set(r,{ status:"exit", time: Date.now() });
  return "EXIT";
} else {
  // No record = allow entry
  await set(r,{ status:"entry", time: Date.now() });
  return "ENTRY";
  }
};

window.updateCount = async function(){
  const r = ref(db, "attendance");
  const snap = await get(r);
  const count = snap.exists() ? Object.keys(snap.val()).length : 0;
  document.getElementById("count").textContent = count;
};
setInterval(window.updateCount,1000);
</script>

<style>
body{background:#000;color:#fff;text-align:center;font-family:Arial;margin:0;padding-top:10px}
h2{color:#00bfff;margin-bottom:5px;text-shadow:0 0 8px #00bfff}
#scanner-box{
  width:80vw;max-width:320px;aspect-ratio:1/1;height:auto;margin:20px auto;position:relative;
}
#scanner-box video{width:100%!important;height:100%!important;object-fit:cover;position:absolute;top:0;left:0;z-index:1;}
#scanner-box:before{
  content:"";position:absolute;inset:0;border:4px solid #00bfff;border-radius:10px;pointer-events:none;box-shadow:0 0 12px #00bfff,0 0 25px #00bfff inset;z-index:5;
}
button{
  background:#00bfff;color:#000;padding:10px 20px;border:none;border-radius:8px;margin:5px;font-weight:bold;box-shadow:0 0 8px #00bfff;cursor:pointer
}
button.hidden{display:none}
#result{margin-top:8px;font-size:20px;font-weight:bold;padding:10px;border-radius:8px;min-height:50px}
#count-box{margin-top:8px;font-size:18px;font-weight:bold;color:#00bfff;text-shadow:0 0 6px #00bfff}
</style>
</head>
<body>
<h2>KALARAVA 2025</h2>
<div id="scanner-box"></div>
<div id="result">Scan a QR</div>

<div>
  <button id="entry-btn" class="hidden">ENTRY</button>
  <button id="exit-btn" class="hidden">EXIT</button>
</div>

<div id="count-box">Total inside: <span id="count">0</span></div>

<script>
let scanner;
let pendingUSN=null;

function show(msg,color){const box=document.getElementById("result");box.style.background=color;box.textContent=msg;}

async function onScan(text){
  await scanner.stop();
  show("Checking...","#222");
  const usn=text.trim().toUpperCase();
  const res=await window.checkEntry(usn,true);

  const entryBtn=document.getElementById("entry-btn");
  const exitBtn=document.getElementById("exit-btn");
  entryBtn.classList.add("hidden");exitBtn.classList.add("hidden");

  if(res==="VALID"){
    show("âœ… VALID QR â€” Tap ENTRY","#0047ab");
    entryBtn.classList.remove("hidden");pendingUSN=usn;
  }
  else if(res==="DUPLICATE"){
    show("â„¹ï¸ Already Inside â€” Tap EXIT","#b30000");
    exitBtn.classList.remove("hidden");pendingUSN=usn;
  }
  else if(res==="BLOCKED"){
    show("âŒ ENTRY NOT ALLOWED â€” Already Exited","#ff0000");
    setTimeout(startScanner,1200);
  }
  else{
    show("âŒ INVALID QR","#cc6600");
    setTimeout(startScanner,1200);
  }
}

async function handleAction(type){
  if(!pendingUSN) return;
  const usn=pendingUSN;pendingUSN=null;
  const res=await window.checkEntry(usn,false);
  if(res==="ENTRY") show("âœ… ENTRY RECORDED","#008f39");
  else if(res==="EXIT") show("âœ… EXIT RECORDED","#0047ab");
  else if(res==="BLOCKED") show("âŒ ENTRY NOT ALLOWED","#ff0000");
  else show("âš ï¸ ERROR","#cc6600");
  document.getElementById("entry-btn").classList.add("hidden");
  document.getElementById("exit-btn").classList.add("hidden");
  setTimeout(startScanner,1200);
}

document.getElementById("entry-btn").onclick=()=>handleAction("entry");
document.getElementById("exit-btn").onclick=()=>handleAction("exit");

function startScanner(){
  show("ðŸ“· Ready","transparent");
  scanner = new Html5Qrcode("scanner-box", { verbose: true });

  // Ensure container has correct layering
  document.getElementById("scanner-box").style.position = "relative";

  // Try back camera first, fallback to default
  // Start scanner with full mobile compatibility
  scanner.start(
    {
      video: {
        facingMode: { ideal: 'environment' },
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    },
    {
      fps: 10,
      qrbox: { width: 250, height: 250 },
    },
    onScan,
    (err) => {
      console.warn("Camera error:", err);
    }
  );
}
startScanner();
</script>
</body>
</html>
