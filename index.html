<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Kalarava QR Logger</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDQ7zrV4Ao9TdJwD0BBOm1Cn7oSL1gEM1A",
  authDomain: "kalarava-scanner-52043.firebaseapp.com",
  databaseURL: "https://kalarava-scanner-52043-default-rtdb.firebaseio.com",
  projectId: "kalarava-scanner-52043",
  storageBucket: "kalarava-scanner-52043.firebasestorage.app",
  messagingSenderId: "550630251161",
  appId: "1:550630251161:web:33391388bb3398167a3608"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ---- Log Function (Firebase + Google Sheets) ----
window.logEntry = async function(usn) {
  usn = usn.trim().toUpperCase();
  if (!usn) return { status: "INVALID" };

  const logsRef = ref(db, "attendance/" + usn + "/logs");
  const newLogRef = push(logsRef);
  const timestamp = new Date().toLocaleString();

  // Save log in Firebase
  await set(newLogRef, { time: timestamp });

  // Fetch current log count
  const snapshot = await get(logsRef);
  const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 1;

  // Update total count node
  await set(ref(db, "attendance/" + usn + "/count"), count);

  // --- Optional: Send data to Google Sheets ---
  /*fetch("https://script.google.com/macros/s/YOUR_SHEET_SCRIPT_ID/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usn, timestamp, count })
  }).catch(err => console.log("Sheets error:", err));

  return { status: "OK", usn, count };*/
};
</script>

<style>
body { background:#000; color:#fff; text-align:center; font-family:Arial; margin:0; padding-top:10px; }
h2 { color:#00bfff; margin-bottom:5px; text-shadow:0 0 8px #00bfff; }
#scanner-box {
  width:80vw; max-width:320px; aspect-ratio:1/1; height:auto; margin:20px auto; position:relative;
}
#scanner-box video {
  width:100%!important; height:100%!important; object-fit:cover; position:absolute; top:0; left:0;
  z-index:1; playsinline:true; -webkit-playsinline:true;
}
#scanner-box:before {
  content:""; position:absolute; inset:0; border:4px solid #00bfff; border-radius:10px;
  pointer-events:none; box-shadow:0 0 12px #00bfff,0 0 25px #00bfff inset; z-index:5;
}
#result {
  margin-top:12px; font-size:20px; font-weight:bold; padding:10px; border-radius:8px;
  min-height:50px; color:#00bfff;
}
</style>
</head>

<body>
<h2>KALARAVA 2025 LOGGER</h2>
<div id="scanner-box"></div>
<div id="result">Scan a QR</div>

<script>
let scanner;

function show(msg, color) {
  const box = document.getElementById("result");
  box.style.color = color;
  box.textContent = msg;
}

async function onScan(text) {
  await scanner.stop();
  show("Processing...", "#aaa");

  const res = await window.logEntry(text);

  if (res.status === "INVALID") {
    show("‚ùå INVALID QR", "#ff4444");
  } else if (res.status === "OK") {
    show(`‚úÖ ${res.usn} ‚Äî Total Entries: ${res.count}`, "#00bfff");
  } else {
    show("‚ö†Ô∏è ERROR", "#ff8800");
  }

  setTimeout(startScanner, 1200);
}

function startScanner() {
  show("üì∑ Ready to scan", "#00bfff");
  scanner = new Html5Qrcode("scanner-box");
  scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScan);
}

startScanner();
</script>
</body>
</html>
