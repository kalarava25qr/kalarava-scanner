<!DOCTYPE html>
<html>
<head>
<title>QR Entry Exit</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Libraries -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

<style>
body{
  background:#02050c;
  color:white;
  font-family:Arial;
  text-align:center;
  margin:0;
}
h2{margin-top:10px;}

#reader{
  width:320px;
  height:320px;
  margin:auto;
  position:relative;
  background:#000;
  border-radius:12px;
}

/* Square neon frame */
.scan-frame{
  position:absolute;
  inset:10px;
  border-radius:10px;
  box-shadow:
    0 0 0 3px #00ffbf inset,
    0 0 20px #00ffbf;
  pointer-events:none;
}

.btn{
  padding:10px 20px;
  border:none;
  border-radius:8px;
  margin:8px;
  font-size:18px;
  cursor:pointer;
}
.entry{background:#00ffbf;color:#000;}
.exit{background:#ff4b4b;color:#fff;}
.switch{background:#5aa0ff;color:white;}

.hidden{display:none;}

#status{
  margin-top:10px;
  padding:12px;
  border-radius:8px;
  font-size:18px;
}
.ok{background:#013616;border:1px solid #00ff90;}
.bad{background:#360000;border:1px solid #ff3838;}

.counter{
  margin:10px auto;
  background:#032b29;
  padding:7px 15px;
  border-radius:8px;
  border:1px solid #00ffbf;
  display:inline-block;
}
</style>
</head>
<body>

<h2>Event QR Gate</h2>

<div class="counter">Inside: <span id="count">0</span></div>

<button id="switchCam" class="btn switch">Switch Camera</button>

<div id="reader"></div>
<div class="scan-frame"></div>

<div id="status">Scan QR…</div>

<div id="actions" class="hidden">
  <button id="entryBtn" class="btn entry">ENTRY</button>
  <button id="exitBtn" class="btn exit">EXIT</button>
</div>

<script>
// ------------------ FIREBASE CONFIG ------------------
// Replace below:
const firebaseConfig = {
  apiKey: "AIzaSyDjk4XNsJaYfoAwkcKrmuTmR7LywjHz7lk",
  authDomain: "kalarava-scanner-87791.firebaseapp.com",
  projectId: "kalarava-scanner-87791",
  storageBucket: "kalarava-scanner-87791.firebasestorage.app",
  messagingSenderId: "521057256617",
  appId: "1:521057256617:web:2752fae1cbef9d9d5855b8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
firebase.auth().signInAnonymously();

// Live counter
db.ref("active").on("value",snap=>{
  document.getElementById("count").textContent = snap.numChildren();
});

let lastUSN=null;
let cameras=[];
let currentCam=0;

function clean(txt){
  let m = String(txt).match(/[A-Za-z0-9]+/g);
  return m ? m.sort((a,b)=>b.length-a.length)[0] : txt;
}

function status(msg,cls=""){ 
  let el = document.getElementById("status");
  el.textContent = msg;
  el.className = cls?`status ${cls}`:"status";
}

const qr = new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(devices=>{
  cameras=devices;
  startScanner(true); // Start rear camera by default
});

// Start scanner
function startScanner(useBack){
  qr.start(
    useBack && cameras.length>1 ? cameras[1].id : cameras[0].id,
    {fps:10, qrbox:{width:280,height:280}},
    scanQR
  );
}

// Switch camera
document.getElementById("switchCam").onclick=()=>{
  currentCam = (currentCam+1) % cameras.length;
  qr.stop().then(()=>startScanner(currentCam==1));
};

// On Scan
async function scanQR(text){
  let usn = clean(text);
  lastUSN=usn;

  let reg = (await db.ref("registry/"+usn).get()).val();
  let used = (await db.ref("used/"+usn).get()).val();
  let active = (await db.ref("active/"+usn).get()).val();

  document.getElementById("actions").classList.add("hidden");

  if(!reg) return status("Invalid QR ❌","bad");
  if(used) return status("Already Exited ❌","bad");

  status("Valid ✅ Choose action","ok");
  let acts=document.getElementById("actions");
  acts.classList.remove("hidden");
  entryBtn.style.display = active?"none":"inline-block";
  exitBtn.style.display  = active?"inline-block":"none";
}

// ENTRY
entryBtn.onclick=async()=>{
  await db.ref("active/"+lastUSN).set({in:Date.now()});
  await db.ref("public/"+lastUSN).set({in:Date.now()});
  status("Entry ✅","ok");
  document.getElementById("actions").classList.add("hidden");
};

// EXIT
exitBtn.onclick=async()=>{
  await db.ref("active/"+lastUSN).remove();
  await db.ref("used/"+lastUSN).set({out:Date.now()});
  await db.ref("public/"+lastUSN+"/out").set(Date.now());
  status("Exit ✅","ok");
  document.getElementById("actions").classList.add("hidden");
};
</script>
</body>
</html>
