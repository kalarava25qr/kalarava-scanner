<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Kalarava QR Logger</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDQ7zrV4Ao9TdJwD0BBOm1Cn7oSL1gEM1A",
  authDomain: "kalarava-scanner-52043.firebaseapp.com",
  databaseURL: "https://kalarava-scanner-52043-default-rtdb.firebaseio.com",
  projectId: "kalarava-scanner-52043",
  storageBucket: "kalarava-scanner-52043.firebasestorage.app",
  messagingSenderId: "550630251161",
  appId: "1:550630251161:web:33391388bb3398167a3608"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- Main logging function ---
window.logEntry = async function(usn) {
  usn = usn.trim().toUpperCase();
  if (!usn) return "INVALID";

  const userRef = ref(db, "attendance/" + usn + "/logs");
  const newLogRef = push(userRef);
  const timestamp = new Date().toLocaleString();

  await set(newLogRef, { time: timestamp });

  // Get updated count
  const snapshot = await get(userRef);
  const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 1;

  // Store count in a separate node for easy access
  await set(ref(db, "attendance/" + usn + "/count"), count);

  return { usn, count, timestamp };
};
</script>

<style>
body { background:#000; color:#fff; text-align:center; font-family:Arial; margin:0; padding-top:10px; }
h2 { color:#00bfff; margin-bottom:5px; text-shadow:0 0 8px #00bfff; }
#scanner-box {
  width:80vw; max-width:320px; aspect-ratio:1/1; height:auto; margin:20px auto; position:relative;
}
#scanner-box video {
  width:100%!important; height:100%!important; object-fit:cover; position:absolute; top:0; left:0;
  z-index:1; playsinline:true; -webkit-playsinline:true;
}
#scanner-box:before {
  content:""; position:absolute; inset:0; border:4px solid #00bfff; border-radius:10px; pointer-events:none;
  box-shadow:0 0 12px #00bfff,0 0 25px #00bfff inset; z-index:5;
}
#result {
  margin-top:8px; font-size:20px; font-weight:bold; padding:10px; border-radius:8px; min-height:50px;
}
#history {
  margin-top:20px; text-align:left; max-width:350px; margin-left:auto; margin-right:auto;
  background:#111; border-radius:10px; padding:10px; font-size:14px; overflow-y:auto; max-height:250px;
}
#history h3 { color:#00bfff; text-align:center; margin:5px 0; }
#history ul { list-style:none; padding:0; margin:0; }
#history li { padding:5px; border-bottom:1px solid #333; }
</style>
</head>

<body>
<h2>KALARAVA 2025 LOGGER</h2>
<div id="scanner-box"></div>
<div id="result">Scan a QR</div>
<div id="history"><h3>Logs</h3><ul id="log-list"></ul></div>

<script>
let scanner;

function show(msg,color){
  const box=document.getElementById("result");
  box.style.background=color;
  box.textContent=msg;
}

async function onScan(text){
  await scanner.stop();
  show("Processing...","#222");

  const res = await window.logEntry(text);

  if(res === "INVALID"){
    show("‚ùå INVALID QR","#cc6600");
  } else {
    show(`‚úÖ ${res.usn} ‚Äî Entry #${res.count}`,"#0047ab");
    addToList(res.usn, res.timestamp, res.count);
  }

  setTimeout(startScanner,1500);
}

// Display logs on screen
function addToList(usn, time, count){
  const list = document.getElementById("log-list");
  const li = document.createElement("li");
  li.textContent = `${usn} | Entry ${count} | ${time}`;
  list.prepend(li);
}

// Start scanner
function startScanner(){
  show("üì∑ Ready to scan","transparent");
  scanner = new Html5Qrcode("scanner-box");
  scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScan);
}
startScanner();
</script>
</body>
</html>
