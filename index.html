<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>QR Gate Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

<style>
body{
  margin:0; background:#020312; color:#e6faff; display:flex; flex-direction:column; align-items:center; font-family:Arial;
}
h2{margin:10px; }
#scanner{ width:90vw; max-width:350px; aspect-ratio:1/1; position:relative; border-radius:12px; overflow:hidden;
background:radial-gradient(circle,#1c1f3c,#05060b); }
.scan-frame{
  position:absolute; inset:10px; border:3px solid transparent;
  border-radius:12px; box-shadow:0 0 0 2px rgba(0,255,200,.8) inset,0 0 25px rgba(0,255,200,.4),0 0 55px rgba(0,255,200,.2);
  animation:pulse 2s infinite;
}
@keyframes pulse{0%,100%{box-shadow:0 0 0 2px rgba(0,255,200,.8) inset,0 0 24px rgba(0,255,200,.5);}50%{box-shadow:0 0 0 2px rgba(120,255,255,.9) inset,0 0 35px rgba(120,255,255,.7);}}
#status{padding:10px; margin-top:10px; border-radius:10px; width:90%; max-width:350px; text-align:center;}
.ok{background:#003b2a; border:1px solid #00ffaa;}
.bad{background:#3b0000; border:1px solid #ff4d4d;}
.btn{margin:5px; padding:10px 20px; border:none; border-radius:8px; font-size:16px; cursor:pointer;}
.entry{background:#00ffb3;color:#000;}
.exit{background:#ff7a7a;color:#000;}
.hidden{display:none;}
.counter{background:#0c1a2b; padding:8px 12px; border:1px solid #00ffaa; border-radius:8px; margin-bottom:10px;}
</style>
</head>
<body>

<h2>QR Entry / Exit</h2>

<div class="counter">Inside: <span id="count">0</span></div>

<div id="scanner"></div>
<div class="scan-frame"></div>

<div id="status">Scan QR...</div>

<div id="actions" class="hidden">
  <button id="entryBtn" class="btn entry">Entry</button>
  <button id="exitBtn" class="btn exit">Exit</button>
</div>

<script>
/* ✅ Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDjk4XNsJaYfoAwkcKrmuTmR7LywjHz7lk",
  authDomain: "kalarava-scanner-87791.firebaseapp.com",
  projectId: "kalarava-scanner-87791",
  storageBucket: "kalarava-scanner-87791.firebasestorage.app",
  messagingSenderId: "521057256617",
  appId: "1:521057256617:web:2752fae1cbef9d9d5855b8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
firebase.auth().signInAnonymously();

/* ✅ Live counter */
db.ref("active").on("value", snap=>{
  document.getElementById("count").textContent = snap.numChildren();
});

let lastID = null;
function cleanId(text){
  const m = String(text).match(/[A-Za-z0-9_\-]+/g);
  return m ? m.sort((a,b)=>b.length-a.length)[0] : text;
}

function setMsg(msg, cls){
  let el = document.getElementById("status");
  el.textContent = msg;
  el.className = cls;
}

const qr = new Html5Qrcode("scanner");

/* ✅ START SCANNER */
Html5Qrcode.getCameras().then(cams=>{
  qr.start(
    cams[0].id,
    {fps:15, qrbox: size=>({width:size*0.8,height:size*0.8})},
    scanCode
  );
});

async function scanCode(text){
  const id = cleanId(text); lastID=id;
  setMsg("Checking...", "");
  document.getElementById("actions").classList.add("hidden");

  let reg = (await db.ref("registry/"+id).get()).val();
  let used = (await db.ref("used/"+id).get()).val();
  let act  = (await db.ref("active/"+id).get()).val();

  if(!reg){
    setMsg("Invalid QR", "bad"); return;
  }
  if(used){
    setMsg("Already used & exited", "bad"); return;
  }

  setMsg("Valid QR", "ok");
  if(act){
    document.getElementById("actions").classList.remove("hidden");
    document.getElementById("entryBtn").style.display="none";
    document.getElementById("exitBtn").style.display="inline-block";
  }else{
    document.getElementById("actions").classList.remove("hidden");
    document.getElementById("entryBtn").style.display="inline-block";
    document.getElementById("exitBtn").style.display="none";
  }
}

/* ✅ ENTRY */
document.getElementById("entryBtn").onclick = async()=>{
  if(!lastID) return;
  await db.ref("active/"+lastID).set({
    ts:Date.now(),
    by:firebase.auth().currentUser.uid
  });
  await db.ref("public/" + currentUSN).set({ in: Date.now() });
  setMsg("Entry Recorded", "ok");
  document.getElementById("actions").classList.add("hidden");
};

/* ✅ EXIT */
document.getElementById("exitBtn").onclick = async()=>{
  if(!lastID) return;
  await db.ref("active/"+lastID).remove();
  await db.ref("used/"+lastID).set(true);
  await db.ref("public/" + currentUSN + "/out").set(Date.now());
  setMsg("Exit Recorded", "ok");
  document.getElementById("actions").classList.add("hidden");
};
</script>
</body>
</html>
