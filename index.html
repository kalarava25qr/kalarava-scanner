<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Kalarava QR Scanner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdrudfhVP6uGo9VzLjFztVmf4zoY2u1hI",
  authDomain: "kalarava-25.firebaseapp.com",
  databaseURL: "https://kalarava-25-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kalarava-25",
  storageBucket: "kalarava-25.firebasestorage.app",
  messagingSenderId: "247264076411",
  appId: "1:247264076411:web:51a116241f77313871f8de"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.checkEntry = async function (usn){
  usn = usn.trim().toUpperCase();
  const r = ref(db,"attendance/"+usn);
  const snap = await get(r);
  
  if(snap.exists()) return "DUPLICATE";

  await set(r,{ scanned:true, time: Date.now() });
  return "VALID";
}
</script>

<style>
body{background:#000;color:#fff;text-align:center;font-family:Arial;margin:0;padding-top:10px}
h2{color:#00ff99;margin-bottom:10px}
#scanner-box{
  width:90vw; max-width:350px;
  height:90vw; max-height:350px;
  margin:auto;
  border:4px solid #00ff99;
  border-radius:10px;
}
#result{
  margin-top:12px;
  font-size:20px;
  font-weight:bold;
  padding:10px;
  border-radius:8px;
  min-height:50px;
}
</style>
</head>

<body>
<h2>KALARAVA 2025 ENTRY</h2>
<div id="scanner-box"></div>
<div id="result">Scan a QR</div>

<script>
let scanner;

function show(msg,color){
  const box=document.getElementById("result");
  box.style.background=color;
  box.textContent=msg;
}

async function onScan(text){
  // Stop scanning immediately to prevent flicker
  await scanner.stop();
  
  show("Checking...","#444");

  const res = await window.checkEntry(text);

  if(res==="VALID") show("‚úÖ VALID ENTRY","#008f39");
  else if(res==="DUPLICATE") show("üö´ DUPLICATE","#b30000");
  else show("‚ùå INVALID","#cc6600");

  setTimeout(startScanner,1200); // restart after 1.2s
}

function startScanner(){
  show("üì∑ Ready to scan","transparent");
  scanner = new Html5Qrcode("scanner-box");
  
  scanner.start(
    {facingMode:"environment"},
    {
      fps:10,
      qrbox:{width:300,height:300},
      aspectRatio:1.0,
      disableFlip:true
    },
    onScan
  );
}

startScanner();
</script>

</body>
</html>
