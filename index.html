<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalarava Gate Scanner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Poppins;text-align:center;padding-top:10px}
h2{color:#00ffee;text-shadow:0 0 10px #00f3ff;font-size:24px}
#scanner-box{
 width:90vw;max-width:350px;
 height:90vw;max-height:350px;
 margin:auto;border:4px solid #00ffee;border-radius:12px;
 box-shadow:0 0 25px #00faff, inset 0 0 10px #00faff;
}
#result{margin-top:10px;padding:12px;font-size:20px;border-radius:10px;min-height:50px;font-weight:bold}
.btn-row{margin-top:10px;display:flex;justify-content:center;gap:15px}
button{padding:14px 25px;font-size:18px;font-weight:600;border:none;border-radius:8px;color:white;cursor:pointer}
.entry-btn{background:#00d46a;box-shadow:0 0 15px #00ff85}
.exit-btn{background:#ff2e2e;box-shadow:0 0 15px #ff5b5b}
#countBox{font-size:18px;margin-bottom:10px;color:#00ffea;text-shadow:0 0 6px #00ffea}
</style>
</head>

<body>
<h2>üéâ KALARAVA GATE SCANNER</h2>
<div id="countBox">Inside: 0</div>
<div id="scanner-box"></div>
<div id="result">Scan QR</div>

<div class="btn-row" id="actionButtons" style="display:none;">
  <button class="entry-btn" id="entryBtn">ENTRY ‚úÖ</button>
  <button class="exit-btn" id="exitBtn">EXIT ‚ùå</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdrudfhVP6uGo9VzLjFztVmf4zoY2u1hI",
  authDomain: "kalarava-25.firebaseapp.com",
  databaseURL: "https://kalarava-25-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kalarava-25",
  storageBucket: "kalarava-25.firebasestorage.app",
  messagingSenderId: "247264076411",
  appId: "1:247264076411:web:51a116241f77313871f8de"
};

// init
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
signInAnonymously(auth);

// Extract USN
function extractUSN(text){
 if(text.includes("usn=")) return text.split("usn=")[1].split("&")[0].toUpperCase();
 return text.trim().toUpperCase();
}

// UI
let scanner, currentUSN="";
const resultBox=document.getElementById("result");
function show(msg,color){resultBox.style.background=color;resultBox.textContent=msg;}

async function entry(usn){
 let r = doc(db,"attendees",usn);
 let snap = await getDoc(r);
 if(!snap.exists()) return show("‚ùå NOT REGISTERED","#ff3300");
 if(snap.data().scanned) return show("‚ö†Ô∏è ALREADY INSIDE","#ff3333");

 await updateDoc(r,{scanned:true,lastUpdated:new Date()});
 addDoc(collection(db,"scanLogs"),{usn,type:"entry",time:new Date()});
 show("‚úÖ ENTRY SUCCESS","#007a33");
}

async function exit(usn){
 let r = doc(db,"attendees",usn);
 let snap = await getDoc(r);
 if(!snap.exists()) return show("‚ùå NOT REGISTERED","#ff3300");
 if(!snap.data().scanned) return show("‚ö†Ô∏è ALREADY OUTSIDE","#ff6600");

 await updateDoc(r,{scanned:false,lastUpdated:new Date()});
 addDoc(collection(db,"scanLogs"),{usn,type:"exit",time:new Date()});
 show("üëã EXIT SUCCESS","#0044ff");
}

// live counter
onSnapshot(doc(db,"counters","entryCounter"), snap=>{
 document.getElementById("countBox").textContent = "Inside: " + (snap.data().totalInside || 0);
});

// Auto update count in Cloud Function or admin panel

async function onScan(raw){
 const usn = extractUSN(raw);
 currentUSN = usn;
 await scanner.stop();
 show("USN: "+usn,"#222");
 document.getElementById("actionButtons").style.display="flex";
}

document.getElementById("entryBtn").onclick = ()=>{entry(currentUSN); setTimeout(reset,1200);};
document.getElementById("exitBtn").onclick = ()=>{exit(currentUSN); setTimeout(reset,1200);};

function reset(){
 startScanner();
 document.getElementById("actionButtons").style.display="none";
 currentUSN="";
}

function startScanner(){
 show("üì∑ Ready to Scan","transparent");
 scanner = new Html5Qrcode("scanner-box");
 scanner.start({facingMode:"environment"}, {fps:12, qrbox:{width:300,height:300}, aspectRatio:1.0}, onScan);
}
startScanner();
</script>
</body>
</html>
