<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fire-Fast QR Gate</title>

  <!-- Styles: neon square scanner (keeps square shape), clean UI -->
  <style>
    @font-face { font-family: Inter; src: local("Inter"); }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Arial;
      background: #0a0a0f; color: #e7e7ff; display: grid; place-items: center; min-height: 100vh;
    }
    .wrap { width: min(96vw, 560px); text-align: center; }
    h1 { margin: 16px 0 6px; letter-spacing: .5px; font-weight: 700; }
    .sub { opacity: .75; font-size: .92rem; margin-bottom: 10px; }

    .counter {
      margin: 8px auto 16px; padding: 10px 14px; width: fit-content;
      background: rgba(50, 255, 170, .08); border: 1px solid rgba(50,255,170,.35);
      border-radius: 10px; backdrop-filter: blur(6px);
    }

    #scannerBox {
      position: relative; width: 100%; aspect-ratio: 1 / 1; /* square */
      border-radius: 12px; overflow: hidden;
      background: radial-gradient(120% 120% at 50% 0%, #141428, #090915 70%);
      box-shadow: 0 0 28px rgba(0,0,0,.6) inset;
    }
    #qrReader { width: 100%; height: 100%; }

    /* Neon square frame (do not change shape) */
    .scan-frame {
      position: absolute; inset: 10px;
      border: 3px solid transparent; border-radius: 12px;
      box-shadow:
        0 0 0 2px rgba(0,255,180,.7) inset,
        0 0 24px rgba(0,255,180,.45),
        0 0 60px rgba(0,255,180,.25);
      animation: pulse 2.4s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes pulse {
      0%, 100% { box-shadow:
          0 0 0 2px rgba(0,255,180,.8) inset,
          0 0 24px rgba(0,255,180,.55),
          0 0 60px rgba(0,255,180,.28); }
      50% { box-shadow:
          0 0 0 2px rgba(140,255,255,.9) inset,
          0 0 30px rgba(140,255,255,.65),
          0 0 70px rgba(140,255,255,.36); }
    }

    .status {
      margin: 14px 0 8px; padding: 10px 12px; border-radius: 10px;
      background: rgba(30, 30, 50, .5); border: 1px solid rgba(120,120,220,.25);
      min-height: 44px; display: grid; place-items: center; font-weight: 600;
    }
    .status.ok  { background: rgba(30, 230, 140, .12); border-color: rgba(30,230,140,.4); }
    .status.bad { background: rgba(255, 80, 80, .12); border-color: rgba(255,80,80,.35); }
    .status.info{ background: rgba(80, 160, 255, .12); border-color: rgba(80,160,255,.35); }

    .actions { display: flex; gap: 10px; justify-content: center; }
    .hidden { display: none !important; }

    .btn {
      all: unset; padding: 11px 18px; border-radius: 10px; cursor: pointer;
      background: #181830; border: 1px solid #34346a;
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
      user-select: none;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.25); }
    .btn:active { transform: translateY(0); }
    .btn-entry {
      border-color: rgba(0,255,180,.5);
      box-shadow: 0 0 20px rgba(0,255,180,.15) inset;
    }
    .btn-exit {
      border-color: rgba(255,120,120,.5);
      box-shadow: 0 0 20px rgba(255,120,120,.12) inset;
    }

    .row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 8px; }
    .chip { padding: 6px 10px; border-radius: 8px; border: 1px solid #34346a; background: #17172f; }
    .last-info { margin-top: 10px; font-size: .95rem; color: #b8b8ff; opacity: .9; }
    .tiny { font-size: .82rem; opacity: .75; }
  </style>

  <!-- html5-qrcode (fast, mobile-friendly) -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- Firebase SDKs (compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>QR Gate</h1>
    <div class="sub tiny">Scan → see Valid/Invalid → then Entry/Exit</div>

    <div class="counter">
      Inside Now: <strong><span id="activeCount">0</span></strong>
    </div>

    <div id="scannerBox">
      <div id="qrReader"></div>
      <div class="scan-frame"></div>
    </div>

    <div id="status" class="status info">Scan a QR…</div>

    <div class="row">
      <div id="idChip" class="chip tiny">ID: —</div>
      <button id="torchBtn" class="btn tiny">Toggle Torch</button>
      <button id="switchBtn" class="btn tiny">Switch Camera</button>
    </div>

    <div id="actions" class="actions hidden">
      <button id="entryBtn" class="btn btn-entry">Entry</button>
      <button id="exitBtn" class="btn btn-exit">Exit</button>
    </div>

    <div id="lastInfo" class="last-info"></div>
  </div>

  <script>
    /* ---------- 1) Firebase init (REPLACE placeholders) ---------- */
    const firebaseConfig = {
  apiKey: "AIzaSyDjk4XNsJaYfoAwkcKrmuTmR7LywjHz7lk",
  authDomain: "kalarava-scanner-87791.firebaseapp.com",
  projectId: "kalarava-scanner-87791",
  storageBucket: "kalarava-scanner-87791.firebasestorage.app",
  messagingSenderId: "521057256617",
  appId: "1:521057256617:web:2752fae1cbef9d9d5855b8"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Anonymous sign-in
    firebase.auth().signInAnonymously().catch(console.error);

    /* ---------- 2) UI helpers ---------- */
    const statusEl  = document.getElementById('status');
    const actionsEl = document.getElementById('actions');
    const entryBtn  = document.getElementById('entryBtn');
    const exitBtn   = document.getElementById('exitBtn');
    const lastInfo  = document.getElementById('lastInfo');
    const idChip    = document.getElementById('idChip');
    const activeCountSpan = document.getElementById('activeCount');

    function setStatus(text, cls='info') {
      statusEl.textContent = text;
      statusEl.className = `status ${cls}`;
    }
    function showActions(showEntry, showExit) {
      actionsEl.classList.remove('hidden');
      entryBtn.style.display = showEntry ? 'inline-block' : 'none';
      exitBtn.style.display  = showExit  ? 'inline-block' : 'none';
    }
    function hideActions() {
      actionsEl.classList.add('hidden');
    }

    // Live total
    db.ref('active').on('value', snap => {
      const count = snap.numChildren();
      activeCountSpan.textContent = count;
      db.ref('metrics/activeCount').set(count);
    });

    /* ---------- 3) Scanner setup ---------- */
    let lastScannedId = null;
    let coolDown = false;
    let html5qr = null;
    let cameras = [];
    let camIndex = 0;
    let torchOn = false;

    function normalizeId(raw) {
      // Adjust this to parse your "script" QR format.
      // Default: choose the longest alnum/_/- token.
      const s = String(raw).trim();
      const tokens = s.match(/[A-Za-z0-9_\-]+/g);
      return tokens ? tokens.sort((a,b)=>b.length-a.length)[0] : s;
    }

    async function handleScan(decodedText) {
      if (coolDown) return;
      coolDown = true; setTimeout(()=> coolDown = false, 600); // debounce

      const id = normalizeId(decodedText);
      lastScannedId = id;
      idChip.textContent = `ID: ${id}`;
      hideActions();
      setStatus('Checking…', 'info');

      const reg    = (await db.ref(`registry/${id}`).get()).val();
      const used   = (await db.ref(`used/${id}`).get()).val();
      const active = (await db.ref(`active/${id}`).get()).val();

      if (!reg) {
        setStatus('Invalid: Not registered', 'bad');
        lastInfo.textContent = '';
        return;
      }
      if (used) {
        setStatus('Invalid: Already used (exit completed)', 'bad');
        lastInfo.textContent = '';
        return;
      }

      // Valid → then show Entry/Exit choices depending on state
      setStatus('Valid QR. Choose action.', 'ok');
      if (active) {
        showActions(false, true); // exit only
        lastInfo.textContent = 'This ID is already inside.';
      } else {
        showActions(true, false); // entry only
        lastInfo.textContent = 'This ID is not inside yet.';
      }
    }

    async function startScanner() {
      html5qr = new Html5Qrcode('qrReader', /* verbose= */ false);
      cameras = await Html5Qrcode.getCameras();
      if (!cameras || !cameras.length) {
        setStatus('No camera found. Allow permission or use a device with camera.', 'bad');
        return;
      }
      camIndex = Math.min(camIndex, cameras.length - 1);
      await html5qr.start(
        cameras[camIndex].id,
        {
          fps: 15,
          qrbox: (vw, vh) => {
            const size = Math.floor(Math.min(vw, vh) * 0.8);
            return { width: size, height: size }; // keep square
          },
          rememberLastUsedCamera: true
        },
        handleScan,
        () => {}
      );
      setStatus('Ready. Scan a QR…', 'info');
    }

    // Torch & camera switch
    const torchBtn = document.getElementById('torchBtn');
    const switchBtn = document.getElementById('switchBtn');
    torchBtn.addEventListener('click', async () => {
      try {
        const track = html5qr.getRunningTrack();
        if (!track) return;
        const cap = track.getCapabilities?.();
        if (!cap || !cap.torch) return alert('Torch not supported on this device.');
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        torchBtn.textContent = torchOn ? 'Torch On' : 'Toggle Torch';
      } catch { /* ignore */ }
    });
    switchBtn.addEventListener('click', async () => {
      try {
        if (html5qr && html5qr.isScanning) {
          await html5qr.stop(); await html5qr.clear();
        }
      } catch {}
      camIndex = (camIndex + 1) % (cameras.length || 1);
      startScanner();
    });

    // Start scanner on load
    window.addEventListener('load', startScanner);

    /* ---------- 4) Entry / Exit actions ---------- */
    entryBtn.addEventListener('click', async () => {
      if (!lastScannedId) return;
      const id = lastScannedId;

      try {
        const [regSnap, usedSnap, actSnap] = await Promise.all([
          db.ref(`registry/${id}`).get(),
          db.ref(`used/${id}`).get(),
          db.ref(`active/${id}`).get()
        ]);
        if (!regSnap.val()) return setStatus('Invalid now (not registered).', 'bad');
        if (usedSnap.val()) return setStatus('Invalid now (already used).', 'bad');
        if (actSnap.val())  return setStatus('Already inside. Use Exit.', 'bad');

        const now = Date.now();
        await db.ref(`active/${id}`).set({
          ts: now,
          by: firebase.auth().currentUser?.uid || 'anon',
          device: navigator.userAgent
        });
        await db.ref('log').push({ id, action: 'ENTRY', ts: now, by: firebase.auth().currentUser?.uid || 'anon' });

        setStatus('Entry recorded.', 'ok');
        hideActions();
      } catch (e) {
        setStatus('Entry failed: ' + e.message, 'bad');
      }
    });

    exitBtn.addEventListener('click', async () => {
      if (!lastScannedId) return;
      const id = lastScannedId;

      try {
        const actSnap = await db.ref(`active/${id}`).get();
        if (!actSnap.val()) return setStatus('Not inside. Nothing to exit.', 'bad');

        const now = Date.now();
        await db.ref(`active/${id}`).remove();   // delete active entry (your requirement)
        await db.ref(`used/${id}`).set(true);    // mark as used so it can’t be valid again
        await db.ref('log').push({ id, action: 'EXIT', ts: now, by: firebase.auth().currentUser?.uid || 'anon' });

        setStatus('Exit recorded. Pass closed.', 'ok');
        hideActions();
      } catch (e) {
        setStatus('Exit failed: ' + e.message, 'bad');
      }
    });
  </script>
</body>
</html>
