<!DOCTYPE html>
<html>
<head>
<title>QR Entry — Exit System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Libraries -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:#02050c;
  color:white;
  font-family:Arial;
  text-align:center;
}

h2{margin-top:15px;}

.counter{
  background:#032b29;
  padding:8px 14px;
  border-radius:10px;
  border:1px solid #00ffbf;
  display:inline-block;
  margin-bottom:10px;
}

/* Scanner wrapper square */
#reader{
  width:320px;
  height:320px;
  margin:auto;
  position:relative;
  background:black;
  border-radius:12px;
  overflow:hidden;
}

/* Neon frame square */
.scan-frame{
  position:absolute;
  top:0; left:0; right:0; bottom:0;
  border-radius:12px;
  box-shadow:
    0 0 0 3px #00ffbf inset,
    0 0 30px #00ffbf;
  pointer-events:none;
}

/* Status Box */
#status{
  margin-top:12px;
  padding:12px;
  border-radius:10px;
  min-height:40px;
  font-size:18px;
}
.ok{background:#003b2b;border:1px solid #00ffaa;}
.bad{background:#3b0000;border:1px solid #ff6a6a;}

/* Buttons */
.btn{
  padding:10px 25px;
  border:none;
  border-radius:8px;
  margin:6px;
  font-size:18px;
  cursor:pointer;
}
.entry{background:#00ffbf;color:#000;}
.exit{background:#ff4b4b;color:#fff;}
.hidden{display:none;}
</style>
</head>

<body>

<h2>Event QR Gate</h2>

<div class="counter">Inside: <span id="count">0</span></div>

<!-- Scanner -->
<div id="reader"></div>
<div class="scan-frame"></div>

<div id="status">Scan QR…</div>

<div id="actions" class="hidden">
  <button id="entryBtn" class="btn entry">ENTRY</button>
  <button id="exitBtn" class="btn exit">EXIT</button>
</div>

<script>
// -------------------- FIREBASE CONFIG --------------------
const firebaseConfig = {
  apiKey: "AIzaSyDjk4XNsJaYfoAwkcKrmuTmR7LywjHz7lk",
  authDomain: "kalarava-scanner-87791.firebaseapp.com",
  projectId: "kalarava-scanner-87791",
  storageBucket: "kalarava-scanner-87791.firebasestorage.app",
  messagingSenderId: "521057256617",
  appId: "1:521057256617:web:2752fae1cbef9d9d5855b8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
firebase.auth().signInAnonymously();

// Live Count
db.ref("active").on("value", s=>{
  document.getElementById("count").textContent = s.numChildren();
});

// Helpers
function clean(t){
  let m=String(t).match(/[A-Za-z0-9]+/g);
  return m?m.sort((a,b)=>b.length-a.length)[0]:t;
}
function status(m,c=""){let e=document.getElementById("status");e.textContent=m;e.className=c?("status "+c):"status";}

let lastUSN=null;

// Scanner
const qr = new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(cams=>{
  // always pick the back camera
  let back = cams.find(x=>x.label.toLowerCase().includes("back")) || cams[0];
  qr.start(
    back.id,
    {fps:12, qrbox:{width:280,height:280}},
    scanQR
  );
});

async function scanQR(text){
  let usn = clean(text);
  lastUSN = usn;

  let reg = (await db.ref("registry/"+usn).get()).val();
  let used = (await db.ref("used/"+usn).get()).val();
  let active = (await db.ref("active/"+usn).get()).val();

  document.getElementById("actions").classList.add("hidden");

  if(!reg) return status("Invalid Pass ❌","bad");
  if(used) return status("Already Exited ❌","bad");

  status("Valid ✅ Select Action","ok");
  let btns = document.getElementById("actions");
  btns.classList.remove("hidden");

  entryBtn.style.display = active ? "none" : "inline-block";
  exitBtn.style.display  = active ? "inline-block" : "none";
}

// ENTRY
entryBtn.onclick=async()=>{
  await db.ref("active/"+lastUSN).set({in:Date.now()});
  await db.ref("public/"+lastUSN).set({in:Date.now()});
  status("Entry ✅","ok");
  document.getElementById("actions").classList.add("hidden");
};

// EXIT
exitBtn.onclick=async()=>{
  await db.ref("active/"+lastUSN).remove();
  await db.ref("used/"+lastUSN).set({out:Date.now()});
  await db.ref("public/"+lastUSN+"/out").set(Date.now());
  status("Exit ✅","ok");
  document.getElementById("actions").classList.add("hidden");
};
</script>
</body>
</html>
