<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Kalarava QR Scanner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDQ7zrV4Ao9TdJwD0BBOm1Cn7oSL1gEM1A",
  authDomain: "kalarava-scanner-52043.firebaseapp.com",
  databaseURL: "https://kalarava-scanner-52043-default-rtdb.firebaseio.com",
  projectId: "kalarava-scanner-52043",
  storageBucket: "kalarava-scanner-52043.firebasestorage.app",
  messagingSenderId: "550630251161",
  appId: "1:550630251161:web:33391388bb3398167a3608"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let mode = "entry"; // entry/exit mode

window.setMode = function(m){ mode = m; updateModeDisplay(); }

async function updateModeDisplay(){
  document.getElementById("mode-label").textContent = mode.toUpperCase();
}

window.checkEntry = async function(usn){
  usn = usn.trim().toUpperCase();
  const r = ref(db,"attendance/"+usn);
  const snap = await get(r);

  if(mode === "entry"){
    if(snap.exists()) return "DUPLICATE";
    await set(r,{ scanned:true, time: Date.now() });
    return "VALID";
  }

  if(mode === "exit"){
    if(!snap.exists()) return "NO-ENTRY";
    await remove(r);
    return "EXIT";
  }
};

window.updateCount = async function(){
  const r = ref(db, "attendance");
  const snap = await get(r);
  const count = snap.exists() ? Object.keys(snap.val()).length : 0;
  document.getElementById("count").textContent = count;
};

setInterval(window.updateCount,1000);
</script>

<style>
body{background:#000;color:#fff;text-align:center;font-family:Arial;margin:0;padding-top:10px}
h2{color:#00bfff;margin-bottom:5px;text-shadow:0 0 8px #00bfff}
#scanner-box{
  width:80vw;
  max-width:320px;
  aspect-ratio:1/1;
  height:auto;
  margin:20px auto;
  position:relative;
}
/* Neon tech frame */
#scanner-box:before{
  content:"";position:absolute;inset:0;border:4px solid #00bfff;border-radius:10px;
  box-shadow:0 0 12px #00bfff,0 0 25px #00bfff inset;
}
button{
  background:#00bfff;color:#000;padding:10px 20px;border:none;border-radius:8px;margin:5px;font-weight:bold;
  box-shadow:0 0 8px #00bfff;cursor:pointer
}
button.active{background:#000;color:#00bfff;border:2px solid #00bfff}
#result{margin-top:8px;font-size:20px;font-weight:bold;padding:10px;border-radius:8px;min-height:50px}
#count-box{margin-top:8px;font-size:18px;font-weight:bold;color:#00bfff;text-shadow:0 0 6px #00bfff}
</style>
</head>

<body>
<h2>KALARAVA 2025 ENTRY</h2>
<div>
  <button id="entry-btn" onclick="setMode('entry')">Entry</button>
  <button id="exit-btn" onclick="setMode('exit')">Exit</button>
</div>
<div id="mode-label" style="margin-top:5px;color:#00bfff;font-size:18px;font-weight:bold"></div>

<div id="scanner-box"></div>
<div id="result">Scan a QR</div>
<div id="count-box">Total inside: <span id="count">0</span></div>

<script>
let scanner;
function show(msg,color){const box=document.getElementById("result");box.style.background=color;box.textContent=msg;}
async function onScan(text){await scanner.stop();show("Checking...","#222");const res = await window.checkEntry(text);if(res==="VALID") show("‚úÖ ENTRY ALLOWED","#008f39");else if(res==="DUPLICATE") show("üö´ ALREADY INSIDE","#b30000");else if(res==="EXIT") show("‚úÖ EXIT RECORDED","#0047ab");else if(res==="NO-ENTRY") show("‚ùå NOT FOUND","#cc6600");else show("‚ùå INVALID","#cc6600");setTimeout(startScanner,1000);} 
function startScanner(){show("üì∑ Ready","transparent");scanner = new Html5Qrcode("scanner-box");scanner.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250},disableFlip:true},onScan);} 
startScanner();window.setMode("entry");
</script>

</body>
</html>
