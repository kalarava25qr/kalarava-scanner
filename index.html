<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Kalarava Entry Scanner</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdrudfhVP6uGo9VzLjFztVmf4zoY2u1hI",
  authDomain: "kalarava-25.firebaseapp.com",
  databaseURL: "https://kalarava-25-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kalarava-25",
  storageBucket: "kalarava-25.firebasestorage.app",
  messagingSenderId: "247264076411",
  appId: "1:247264076411:web:51a116241f77313871f8de"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.verifyQR = async function(usn) {
  const entryRef = ref(db, "attendance/" + usn);
  const snap = await get(entryRef);
  if (snap.exists()) return "DUPLICATE";

  await set(entryRef, { scanned: true, time: Date.now() });
  return "VALID";
}
</script>

<style>
body {
  margin:0; background:#000; color:#fff;
  font-family: Arial; text-align:center;
}
h2 { color:#00ff99; margin:12px; font-size:22px; }
#reader {
  width: 90vw; max-width:350px;
  height: 90vw; max-height:350px;
  border: 4px solid #00ff99;
  border-radius: 12px;
  margin: auto; margin-top:10px;
}
#result {
  margin-top: 12px;
  font-size: 20px;
  font-weight: bold;
  padding: 12px;
  border-radius: 8px;
  min-height: 50px;
}
</style>
</head>

<body>
<h2>üéâ KALARAVA 2025 ENTRY SCANNER</h2>
<div id="reader"></div>
<div id="result">üì∑ Scan QR to Begin</div>

<script>
const resultBox = document.getElementById("result");

function show(text,color="transparent") {
  resultBox.style.background = color;
  resultBox.textContent = text;
}

function restart() {
  setTimeout(() => {
    show("üì∑ Ready for next scan","transparent");
    startScanner();
  }, 1200);
}

async function handleScan(qr){
  show("‚è≥ Checking...", "#222");
  const res = await window.verifyQR(qr);

  if (res === "VALID") show("‚úÖ VALID ENTRY", "#008f39");
  else if (res === "DUPLICATE") show("üö´ ALREADY SCANNED", "#b30000");
  else show("‚ùå INVALID QR", "#cc6600");

  restart();
}

function startScanner() {
  const qr = new Html5Qrcode("reader");
  qr.start(
    { facingMode:"environment" },
    { fps:12, qrbox:{width:300,height:300}, aspectRatio:1.0 },
    handleScan
  );
}

startScanner();
</script>
</body>
</html>
